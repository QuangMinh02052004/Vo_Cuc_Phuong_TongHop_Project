<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="images/logo.png">
    <title>Migration - Fix senderStation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            padding: 40px;
            background: #f5f5f5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        .warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .info {
            background: #d1ecf1;
            border: 1px solid #17a2b8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }

        .btn:hover {
            background: #0056b3;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        #log {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }

        .log-success {
            color: #28a745;
        }

        .log-error {
            color: #dc3545;
        }

        .log-info {
            color: #17a2b8;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üîß Migration Tool - C·∫≠p nh·∫≠t senderStation</h1>

        <div class="warning">
            <strong>‚ö†Ô∏è C·∫£nh b√°o:</strong>
            <p>Script n√†y s·∫Ω c·∫≠p nh·∫≠t t·∫•t c·∫£ products c≈© kh√¥ng c√≥ <code>senderStation</code>.</p>
            <p><strong>L∆ØU √ù:</strong> V√¨ kh√¥ng bi·∫øt tr·∫°m n√†o ƒë√£ g·ª≠i h√†ng c≈©, script s·∫Ω <strong>X√ìA T·∫§T C·∫¢</strong> products kh√¥ng c√≥ senderStation.</p>
        </div>

        <div class="info">
            <strong>‚ÑπÔ∏è Khuy·∫øn ngh·ªã:</strong>
            <p>N·∫øu ƒë√¢y l√† d·ªØ li·ªáu test, b·∫°n n√™n x√≥a h·∫øt v√† t·∫°o m·ªõi.</p>
            <p>N·∫øu ƒë√¢y l√† d·ªØ li·ªáu th·∫≠t, li√™n h·ªá developer ƒë·ªÉ migration th·ªß c√¥ng.</p>
        </div>

        <div style="margin-top: 20px;">
            <button class="btn btn-danger" onclick="deleteOldProducts()">
                üóëÔ∏è X√≥a t·∫•t c·∫£ products c≈© (kh√¥ng c√≥ senderStation)
            </button>
            <button class="btn" onclick="location.href='index.html'">
                ‚Üê Quay l·∫°i
            </button>
        </div>

        <div id="log" style="display: none;">
            <div id="logContent"></div>
        </div>
    </div>

    <script type="module">
        import {
            getAllProducts,
            deleteProduct
        } from './js/firebase-db.js';

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const logContent = document.getElementById('logContent');
            logDiv.style.display = 'block';

            const span = document.createElement('div');
            span.className = `log-${type}`;
            span.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContent.appendChild(span);

            // Auto scroll to bottom
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        window.deleteOldProducts = async function() {
            if (!confirm('‚ö†Ô∏è B·∫†N CH·∫ÆC CH·∫ÆN MU·ªêN X√ìA T·∫§T C·∫¢ PRODUCTS C≈®?\n\nH√†nh ƒë·ªông n√†y KH√îNG TH·ªÇ HO√ÄN T√ÅC!')) {
                return;
            }

            if (!confirm('‚ö†Ô∏è X√ÅC NH·∫¨N L·∫¶N CU·ªêI!\n\nT·∫•t c·∫£ products kh√¥ng c√≥ senderStation s·∫Ω b·ªã X√ìA Vƒ®NH VI·ªÑN!')) {
                return;
            }

            log('=== B·∫ÆT ƒê·∫¶U X√ìA PRODUCTS C≈® ===', 'info');

            try {
                const products = await getAllProducts();
                log(`T·ªïng s·ªë products: ${products.length}`, 'info');

                const oldProducts = products.filter(p => !p.senderStation);
                log(`Products c≈© c·∫ßn x√≥a: ${oldProducts.length}`, 'info');

                if (oldProducts.length === 0) {
                    log('‚úÖ Kh√¥ng c√≥ products c≈© n√†o c·∫ßn x√≥a!', 'success');
                    alert('Kh√¥ng c√≥ products c≈© n√†o c·∫ßn x√≥a!');
                    return;
                }

                let deletedCount = 0;
                let errorCount = 0;

                for (const product of oldProducts) {
                    try {
                        await deleteProduct(product.id);
                        deletedCount++;
                        log(`‚úÖ ƒê√£ x√≥a product ${product.id}`, 'success');
                    } catch (error) {
                        errorCount++;
                        log(`‚ùå L·ªói khi x√≥a product ${product.id}: ${error.message}`, 'error');
                    }
                }

                log('=== K·∫æT QU·∫¢ ===', 'info');
                log(`‚úÖ ƒê√£ x√≥a: ${deletedCount} products`, 'success');
                log(`‚ùå L·ªói: ${errorCount} products`, 'error');
                log('=============', 'info');

                alert(`Ho√†n t·∫•t!\nƒê√£ x√≥a: ${deletedCount} products\nL·ªói: ${errorCount} products\n\nB√¢y gi·ªù b·∫°n c√≥ th·ªÉ t·∫°o ƒë∆°n h√†ng m·ªõi!`);

            } catch (error) {
                log(`‚ùå L·ªói: ${error.message}`, 'error');
                alert('C√≥ l·ªói x·∫£y ra! Xem log ƒë·ªÉ bi·∫øt chi ti·∫øt.');
            }
        };
    </script>
</body>

</html>
